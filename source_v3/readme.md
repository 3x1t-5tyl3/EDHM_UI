This is the code for new version 3.x
